

### 应用拆分

![](http://mmbiz.qpic.cn/mmbiz/sXiaukvjR0RA4LTYdW8vIiaBFNyKAP0khnKvib5CIjF3ibc9ytWgB6Z6Ggo9d4D2aarWJQEiauicBBffEtlMI44yzIfw/640?wx_fmt=png&wxfrom=5&wx_lazy=1)

这张图从三个维度概括了一个系统的扩展过程：(1)x 轴，水平复制，即在负载均衡服务器后增加多个 web 服务器；(2)z 轴扩展，是对数据库的扩展，即分库分表(分库是将关系紧密的表放在一台数据库服务器上，分表是因为一张表的数据太多，需要将一张表的数据通过 hash 放在不同的数据库服务器上)；(3)y 轴扩展，是功能分解，将不同职能的模块分成不同的服务。从 y 轴这个方向扩展，才能将巨型应用分解为一组不同的服务，例如订单管理中心、客户信息管理中心、商品管理中心等等。

将系统划分为不同的服务有很多方法：(1)按照用例划分，例如在线商店系统中会划分出一个 checkout UI 服务，这个服务实现了 checkout 这个用例；(2)按照资源划分，例如可以划分出一个 catlog 服务来存储产品目录。

服务划分有两个原则要遵循：(1)每个服务应该尽可能符合单一职责原则——Single Responsible Principle，即每个服务只做一件事，并把这件事做好；(2)参考 Unix 命令行工具的设计，Unix 提供了大量的简单易用的工具，例如 grep、cat 和 find。每个工具都小而美。

最后还要强调：系统分解的目标并不仅仅是搞出一堆很小的服务，这不是目标；真正的目标是解决巨石型应用在业务急剧增长时遇到的问题。

对于上面的例子，按照功能和资源划分后，就形成下面图 3 的架构图。分解后的微服务架构包含多个前端服务和后端服务。前端服务包括 Catalog UI(用于商品搜索和浏览)、Checkout UI(用于实现购物车和下单操作)；后端服务包括一些业务逻辑模块，我们将在巨石应用中的每个服务模块重构为一个单独的服务。这么做有什么问题呢？

![](http://mmbiz.qpic.cn/mmbiz/sXiaukvjR0RA4LTYdW8vIiaBFNyKAP0khnWXC4ic9Awg5hWwrs0lzqvX7qibm2riaxQCsmfZ0zreu1jV57Ds7Wwju3A/640?wx_fmt=png&wxfrom=5&wx_lazy=1)

# 微服务应用

想象一个向消费者提供产品信息的分布式系统。如下图，这个服务由 7 个微服务组成，从 A 到 G。A 服务存储了用户的个人信息。B 服务存储用户的登录账户信息，如用户上一次登录的时间和访问了什么信息。C 服务是关于产品信息的。D 服务作为 API 网关处理所有来自外部的接口访问。

![](https://ww1.sinaimg.cn/large/007rAy9hly1g09powuwc2j30gt1r1tcm.jpg)

来看一个请求的例子，用户通过手机 App 访问了一些信息：

请求首先进入 D 服务，即 API 服务；
D 服务本身并没有所有需要的信息，所以它进一步请求 C 服务和 F 服务以获取必要的数据；
C 服务和 F 服务也同时都需要更多的信息来满足请求，于是 C 服务请求 A 服务，F 服务请求了 B 服务和 G 服务；
A 服务也需要访问 B 服务，B 服务需要访问 E 服务，同时 G 服务也需要访问 E 服务；
对 D 服务的一个请求，扩散到了整个微服务架构里。而且当所有依赖的服务没有返回或者超时之前，API 不会向手机 App 返回响应。
